<!DOCTYPE html>
<html>
<head>
    <title>Etusivu | HOAS-arvostelut</title>
    <link href="css/main.css" type="text/css" rel="stylesheet"/>
    <!--<script src="main.js"></script>-->
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>

<ul id="menu">
    <!--onclick="visibleLogin()"-->
    <li><a onclick="visibleLogin()" class="active" href="/login">Kirjaudu</a></li>
    <li><a href="/register">Rekisteröidy</a></li>
    <h1>HOAS-arvostelut</h1>
    <input id="search" type="text" placeholder="Hae kohdetta" name="search" onkeyup="searchApartment()">
</ul>


<div id="login_wrap">
    <form>
        Käyttäjätunnus: <input id="username" type="text" name="username">
        Salasana: <input id="password" type="password">
        <button class="openapartment" onclick="hideLogin()" id="submit" type="submit">Kirjaudu</button>
    </form>
</div>

<main>
    <ul id="apartments">
        <!--When li element clicked modal opens-->
        <li>
            <figure>
                <a onclick="getApartmentId(this.id)" id="1" class="review"><img src="img/kimpitie.jpg"></a>
                <figcaption>
                    <h3>Kimpitie 10, Helsinki</h3>
                </figcaption>
                <button onclick="getApartmentId('1')" class="rate" >Arvostele</button>
            </figure>
        </li>
        <li>
            <figure>
                <a  onclick="getApartmentId(this.id)" id="2" class="review"><img src="img/berliininkatu.jpg"></a>
                <figcaption>
                    <h3>Berliininkatu 5, Arabia-Toukola Helsinki</h3>
                </figcaption>
                <button onclick="getApartmentId('2')"class="rate">Arvostele</button>
            </figure>
        </li>
        <li>
            <figure>
                <a onclick="getApartmentId(this.id)" id="3" class="review"><img src="img/hakaniemenranta.jpg"></a>
                <figcaption>
                    <h3>Hakaniemenranta 12, Helsinki</h3>
                </figcaption>
                <button class="rate">Arvostele</button>
            </figure>
        </li>
        <li>
            <figure>
                <a onclick="getApartmentId(this.id)" id="4" class="review"><img src="img/siltakuja.jpg"></a>
                <figcaption>
                    <h3>Siltakuja 2, Espoon keskus</h3>
                </figcaption>
                <button class="rate">Arvostele</button>
            </figure>
        </li>
        <li>
            <figure>
                <a onclick="getApartmentId(this.id)" id="5" class="review"><img src="img/vaskivuorentie.jpg"></a>
                <figcaption>
                    <h3>Vaskivuorentie 22, Myyrmaki Vantaa</h3>
                </figcaption>
                <button class="rate">Arvostele</button>
            </figure>
        </li>
        <li>
            <figure>
                <a onclick="getApartmentId(this.id)" id="6" class="review"><img src="img/juusintie.jpg"></a>
                <figcaption>
                    <h3>Juusintie 5, Kauniainen</h3>
                </figcaption>
                <button class="rate">Arvostele</button>
            </figure>
        </li>
        <li>
            <figure>
                <a onclick="getApartmentId(this.id)" id="7" class="review"><img src="img/kilonkallio.jpg"></a>
                <figcaption>
                    <h3>Kilonkallio 10, Kilo Espoo</h3>
                </figcaption>
                <button class="rate">Arvostele</button>
            </figure>
        </li>
        <li>
            <figure>
                <a onclick="getApartmentId(this.id)" id="8" class="review"><img src="img/haukilahdenkuja.jpg"></a>
                <figcaption>
                    <h3>Haukilahdenkuja 15, Hermanni-Sörnäinen Helsinki</h3>
                </figcaption>
                <button class="rate">Arvostele</button>
            </figure>
        </li>
        <li>
            <figure>
                <a onclick="getApartmentId(this.id)" id="9" class="review"><img src="img/leppäsuonkatu.jpg"></a>
                <figcaption>
                    <h3>Leppäsuonkatu 7, Kamppi Helsinki</h3>
                </figcaption>
                <button class="rate">Arvostele</button>
            </figure>
        </li>
        <li>
            <figure>
                <a onclick="getApartmentId(this.id)" id="10" class="review"><img src="img/majurinkulma.jpg"></a>
                <figcaption>
                    <h3>Majurinkulma 2, Leppävaara-Lintuvaara Espoo</h3>
                </figcaption>
                <button class="rate">Arvostele</button>
            </figure>
        </li>
        <li>
            <figure>
                <a onclick="getApartmentId(this.id)" id="11" class="review"><img src="img/servinkuja.jpg"></a>
                <figcaption>
                    <h3>Servinkuja 6, Otaniemi teekkarikylä Espoo</h3>
                </figcaption>
                <button class="rate">Arvostele</button>
            </figure>
        </li>
        <li>
            <figure>
                <a onclick="getApartmentId(this.id)" id="12" class="review"><img src="img/akanapolku.jpg"></a>
                <figcaption>
                    <h3>Akanapolku 2, Jokiniemi-Tikkurila Vantaa</h3>
                </figcaption>
                <button class="rate">Arvostele</button>
            </figure>
        </li>
    </ul>
</main>

<div id="newchat">
    <!--<label for="title">Kirjoita kysymys aloittaaksesi keskustelun:</label>-->
    <input  id="chatTitle" type="text" placeholder="Kirjoita kysymys aloittaaksesi keskustelun" name="chat">
    <button onclick="addNewChat()">Lähetä</button>
    <ul onclick="openChat()" id="chat"></ul>
</div>

<div id="chatcontents">
    <h2>Tähän klikatun keskustelun otsikko tietokannasta</h2>
    <p>Tähän listana vastauksia kysymyksiin</p>
    <input type="text" placeholder="Kirjoita vastaus (max 500 merkkiä)">
    <button>Lähetä vastaus</button>
</div>

<div class="footer">
    <p>Kaikki kuvat otettu HOAS:in sivuilta:</p>
    <a href="https://www.hoas.fi/">https://www.hoas.fi/</a>
</div>

<!-- Modal -->
<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close">x</span>
        <h2 id="address">Tähän haetaan tietokannasta klikatun asunnon osoite</h2>
        <p id="rating"></p>
        <div id="review">
            <h3>Kunto:</h3><p id="shape"></p>
            <h3>Viihtyvyys:</h3>
            <p id="comfort"></p>
            <!--<span class="fa fa-star checked"></span>
            <span class="fa fa-star checked"></span>
            <span class="fa fa-star checked"></span>
            <span class="fa fa-star"></span>
            <span class="fa fa-star"></span>-->
            <h3>Kokonaisarvosana:</h3><p id="grade"></p>
            <h3>Vapaa sana:</h3><p id="free_word"></p>
        </div>

        <h2>Arvostelujen keskiarvot:</h2>
        <div class="starcontainer">
            <p>Kunto</p>
            <p class="center" id="">3</p>
            <img id="star" src="img/star.jpg">
        </div>
    </div>
</div>

<div id="modal2" class="modal2">
    <div class="modal-content2">
        <span class="close2">x</span>
        <h2 style="display: inline-block">Arvostelu kohteeseen: </h2>
        <h2 style="display: inline-block" id="apartmentaddress"></h2>
        <h3 ></h3>
        <form>
            <fieldset>
                <legend>Kunto</legend>
                <select>
                    <option value="item1">Kiitettävä</option>
                    <option value="item2">Hyvä</option>
                    <option value="item3">Tyydyttävä</option>
                    <option value="item4">Välttävä</option>
                </select>
            </fieldset>
            <fieldset>
                <legend>Viihtyvyys</legend>
                <select>
                    <option value="item1">5</option>
                    <option value="item2">4</option>
                    <option value="item3">3</option>
                    <option value="item4">2</option>
                    <option value="item4">1</option>
                </select>
            </fieldset>
            <fieldset>
                <legend>Kokonaisarvosana</legend>
                <select>
                    <option value="item1">5</option>
                    <option value="item2">4</option>
                    <option value="item3">3</option>
                    <option value="item4">2</option>
                    <option value="item4">1</option>
                </select>
            </fieldset>
            <br>
            <fieldset>
                <legend>Vapaa sana</legend>
                <textarea style="width: 60%" placeholder="Kirjoita vapaasti kokemuksia ja mielipiteitä asunnosta" rows="10" ></textarea>
            </fieldset>
            <button>Lähetä</button>
        </form>
    </div>
</div>

<script>
    function addNewChat() {
        const title = document.getElementById('chatTitle').value;
        console.log(title);

        const li = document.createElement('li');
        li.innerHTML = title + "<br>";

        const chat = document.getElementById('chat');
        chat.appendChild(li);
    }

    function openChat() {
        var ischatopen = document.getElementById('chatcontents').style.visibility;
        console.log(ischatopen);

        if (ischatopen === "visible") {
            document.getElementById('chatcontents').style.visibility = "hidden";
            document.getElementById('chatcontents').style.display = "none";
        } else {
            document.getElementById('chatcontents').style.visibility = "visible";
            document.getElementById('chatcontents').style.display = "block";
        }
    }

    function searchApartment() {
        let input, uppercase, ul, li, h3, i, text;

        //Get search input field
        input = document.getElementById('search');

        //Input value to uppercase
        uppercase = input.value.toUpperCase();

        //List of apartments
        ul = document.getElementById('apartments');
        li = ul.getElementsByTagName('li');
            for (i = 0; i < li.length; i++) {
                h3 = li[i].getElementsByTagName('h3')[0];
                text = h3.innerText;
                if (text.toUpperCase().indexOf(uppercase) > -1) {
                    li[i].style.display = '';
                } else {
                    li[i].style.display = 'none';
                }
            }
        }

        function getApartmentId(clicked_id){
            console.log("clicked id " + clicked_id);
            return clicked_id;
        }

    window.onload = function(){

        makeQueryForChat();

        //VIEW REVIEWS

        //Get the modal
        var modal = document.getElementById("modal");
        var apartments = document.getElementsByClassName('review');

        for(var i = 0; i < apartments.length; i++) {
                console.log("apartments lenght " + apartments.length);
                var apartment = i;
                console.log(apartments[i]);
                console.log("monesko alkio klikattu " + apartment);

                apartments[i].getApartmentId = function (i) {
                    console.log("klikattu asunto " + i);
                    //apartment = getApartmentId();
                    //console.log("getapartmentid " + apartment);
                    makeQueryForShowReviews(i);
                    modal.style.display = "block";
                }

        }

        //Close the modal, when the user clicks on <span> (x)
        var span = document.getElementsByClassName("close")[0];
        span.onclick = function() {
            modal.style.display = "none";
        }

        //Close modal, when the user clicks anywhere outside of the modal
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        //ADD REVIEW
        var modal2 = document.getElementById("modal2");
        console.log("after get modal");

        var ratebuttons = document.getElementsByClassName("rate");
        console.log("after get arvostele button");

        for(var a = 0; a < ratebuttons.length; a++) {
            console.log("apartments lenght " + ratebuttons.length);
            var ratebutton = a;
            console.log(ratebuttons[a]);
            console.log("monesko alkio klikattu " + ratebutton);

            ratebuttons[a].getApartmentId = function (a) {
                console.log("klikattu asunto " + a);
                //apartment = getApartmentId();
                //console.log("getapartmentid " + apartment);
                makeQueryForAddNewReview(a);
                modal2.style.display = "block";
            }

        }

        var span2 = document.getElementsByClassName("close2")[0];
        console.log("after get close");

        ratebuttons.onclick = function() {
            getApartmentId();
            console.log("open modal when user clicks arvostelebutton");
            modal2.style.display = "block";
        }

        span2.onclick = function() {
            modal2.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal2) {
                modal2.style.display = "none";
            }
        }
    };

    // Main page "log in pop-up" functions
    function visibleLogin() {
        const isloginopen = document.getElementById('login_wrap').style.visibility;
        console.log(isloginopen);
        if (isloginopen === 'visible') {
            document.getElementById('login_wrap').style.visibility = 'hidden';
            document.getElementById('login_wrap').style.display = 'none';
        } else {
        document.getElementById('login_wrap').style.visibility = 'visible';
        document.getElementById('login_wrap').style.display = 'block';
        }
    }

    function hideLogin() {
        document.getElementById('login_wrap').style.visibility = 'hidden';
    }

    //SERVER JS
    let json; //json is global...

    function makeQueryForShowReviews(apartment) {

        const id = apartment;
        console.log(id);

            const xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function() {
                if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
                    json = JSON.parse(xmlhttp.responseText);
                    console.log(json);
                    //myFunction(resultArr);
                    //document.getElementById("info").innerHTML = xmlhttp.responseText;
                    if (json.length > 0) { // something found
                        //console.log(json.length + ", " + json.rows[0].Name);
                        showList(json);
                    } else {
                        document.getElementById(
                            'rating').innerHTML = '<br/>Arvosteluita ei löytynyt yhtään.';
                    }
                }
            };
            const searchedid = id;
            console.log('Haettu id: ' + searchedid);
            console.log('http://localhost:3000/api/results?id=' + searchedid);
            xmlhttp.open('GET', 'http://localhost:3000/api/results?id=' + searchedid,
                true);
            xmlhttp.send();
    }

    function showList(json) {
        console.log('showList');

        /*const divElement = document.getElementById('rating');

        const address = document.getElementById("address");
        let stringaddress;

        const shape = document.getElementById("shape");
        let stringshape;

        const comfort = document.getElementById("comfort");
        let stringcomfort;

        const grade = document.getElementById("grade");
        let stringrade;

        const free_word = document.getElementById("free_word");
        let string_free_word;

        let i;
        let string;

        for (i in json) {
            string = json[i].id + ', ' + json[i].osoite + ', ' + json[i].kunto +
                ', ' + json[i].viihtyvyys + ', ' + json[i].kokonaisarvosana + ', ' +
                json[i].vapaasana;

            divElement.innerHTML = string;

            stringaddress = json[i].osoite;
            address.innerHTML = stringaddress;

            stringshape = json[i].kunto;
            shape.innerHTML = stringshape;

            stringcomfort = json[i].viihtyvyys;
            comfort.innerHTML = stringcomfort;

            stringrade = json[i].kokonaisarvosana;
            grade.innerHTML = stringrade;

            string_free_word = json[i].vapaasana;
            free_word.innerHTML = string_free_word;

            console.log(string);
        }*/
        const divElement = document.getElementById('rating');

        const address = document.getElementById("address");
        let stringaddress;

        const shape = document.getElementById("shape");
        let stringshape;

        const comfort = document.getElementById("comfort");
        let stringcomfort;

        const grade = document.getElementById("grade");
        let stringrade;

        const free_word = document.getElementById("free_word");
        let string_free_word;

        let i;
        let string;

        for (i in json) {
            string = json[i].id + ', ' + json[i].address + ', ' + json[i].shape +
                ', ' + json[i].comfort + ', ' + json[i].grade + ', ' +
                json[i].free_word;

            divElement.innerHTML = string;

            stringaddress = json[i].address;
            address.innerHTML = stringaddress;

            stringshape = json[i].shape;
            shape.innerHTML = stringshape;

            stringcomfort = json[i].comfort;
            comfort.innerHTML = stringcomfort;

            stringrade = json[i].grade;
            grade.innerHTML = stringrade;

            string_free_word = json[i].free_word;
            free_word.innerHTML = string_free_word;

            console.log(string);
        }
    }

    function makeQueryForChat() {

        const xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
                json = JSON.parse(xmlhttp.responseText);
                console.log(json);
                if (json.length > 0) { // something found
                    //console.log(json.length + ", " + json.rows[0].Name);
                    showList2(json);
                } else {

                }
            }
        };
        console.log('http://localhost:3000/chat');
        xmlhttp.open('GET', 'http://localhost:3000/chat', true);
        xmlhttp.send();
    }

    function showList2(json) {
        console.log('showList2');

        let stringheader;

        let i;
        let string;

        for (i in json) {
            string = json[i].username + ', ' + json[i].header;

            const chat = document.getElementById('newchat');
            const newheader = document.createElement('li');
            chat.appendChild(newheader);

            stringheader = string;
            newheader.innerHTML = stringheader;

            console.log(string);
        }
    }

    function makeQueryForAddNewReview(apartment) {

        const id = apartment;
        console.log(id);

        const xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
                json = JSON.parse(xmlhttp.responseText);
                console.log(json);
                //myFunction(resultArr);
                //document.getElementById("info").innerHTML = xmlhttp.responseText;
                if (json.length > 0) { // something found
                    //console.log(json.length + ", " + json.rows[0].Name);
                    showList3(json);
                } else {
                    document.getElementById(
                        'apartmentaddress').innerHTML = '<br/>Ei löytynyt asunnon osoitetta.';
                }
            }
        };
        const searchedid = id;
        console.log('Haettu id: ' + searchedid);
        console.log('http://localhost:3000/api/results?id=' + searchedid);
        xmlhttp.open('GET', 'http://localhost:3000/api/results?id=' + searchedid,
            true);
        xmlhttp.send();
    }

    function showList3(json) {
        console.log('showList');

        const addrress = document.getElementById('apartmentaddress');
        let stringaddress;

        let i;
        let string;

        for (i in json) {
            string = json[i].id + ', ' + json[i].osoite + ', ' + json[i].kunto +
                ', ' + json[i].viihtyvyys + ', ' + json[i].kokonaisarvosana + ', ' +
                json[i].vapaasana;

            stringaddress = json[i].osoite;
            addrress.innerHTML = stringaddress;

            console.log(string);
        }
    }
</script>
</body>
</html>
